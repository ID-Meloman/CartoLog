{% extends 'main/layout.html' %}

{% load static %}
{% block title %}CartoLog{% endblock %}

{% block links %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'main/css/popular.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMliKLnmY5c9b0CJv18MG8IE1FZnX9czD59lfgd" crossorigin="anonymous">
{% endblock %}

{% block body %}
{% include 'main/header.html' %}

<div class="filter-container">
    <div class="form-row">
        <div class="form-group">
            <label for="brand-filter">Марка автомобиля:</label>
            <select id="brand-filter" class="form-control">
                <option value="">Все марки</option>
                {% for brand in brands %}
                <option value="{{ brand.id }}">{{ brand.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="model-filter">Модель автомобиля:</label>
            <select id="model-filter" class="form-control" disabled>
                <option value="">Выберите модель</option>
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="drive-type-filter">Тип привода:</label>
            <select id="drive-type-filter" class="form-control">
                <option value="">Выберите тип привода</option>
                {% for drive_type in drive_types %}
                <option value="{{ drive_type }}">{{ drive_type }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="transmission-filter">Коробка передач:</label>
            <select id="transmission-filter" class="form-control">
                <option value="">Выберите коробку передач</option>
                {% for transmission in transmissions %}
                <option value="{{ transmission }}">{{ transmission }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="horsepower-min">Мощность (л.с.): от:</label>
            <input type="number" id="horsepower-min" class="form-control" placeholder="Минимальная мощность">
        </div>

        <div class="form-group">
            <label for="horsepower-max">Мощность (л.с.): до:</label>
            <input type="number" id="horsepower-max" class="form-control" placeholder="Максимальная мощность">
        </div>
    </div>

    <div class="button-container">
        <button id="apply-filters" class="btn btn-primary" style="margin-top: 25px;">Применить фильтры</button>
        <button id="reset-filters" class="btn btn-danger" style="margin-top: 40px;">Сбросить фильтры</button>
    </div>
</div>


<div class="card-container" id="car-list">
    {% for item in filter.qs %}
    <div class="card">
    {% if item.image %}
    <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.model }}">
    {% else %}
    <img src="{% static 'main/img/logo.png' %}" class="card-img-top" alt="Default image">
    {% endif %}

    <div class="favorite-icon-container">
        <form method="POST" action="{% url 'toggle_favorite' item.id %}">
            {% csrf_token %}
            <button
                class="favorite-toggle"
                data-car-id="{{ item.id }}"
                data-url="{% url 'toggle_favorite' item.id %}">
    <svg class="favorite-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="red" viewBox="0 0 16 16" style="{% if item in favorite_cars %}display: inline;{% else %}display: none;{% endif %}">
        <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
    </svg>
    <svg class="non-favorite-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="red" viewBox="0 0 16 16" style="{% if item in favorite_cars %}display: none;{% else %}display: inline;{% endif %}">
        <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
    </svg>
        </button>
        </form>
    </div>

    <div class="card-body">
        <h5 class="card-title">{{ item.model }} - {{ item.configuration.name }}</h5>
        <p class="card-text">
            Лошадиные силы: {{ item.configuration.technical_specs.horsepower }} л.с.<br>
            Крутящий момент: {{ item.configuration.technical_specs.torque }} Нм<br>
            Коробка передач: {{ item.configuration.transmission_drive.transmission }}<br>
            Тип привода: {{ item.configuration.transmission_drive.drive_type }}
        </p>
        <a href="{% url 'car_detail' item.id %}" class="btn btn-primary">Подробнее</a>
    </div>
</div>

    {% endfor %}
</div>


<script>
$('.favorite-toggle').click(function(e) {
    e.preventDefault(); // предотвращаем перезагрузку страницы
    const button = $(this);
    const carId = button.data('car-id');
    const url = button.data('url');

    $.ajax({
        url: url,
        type: 'POST',
        data: {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.is_favorite) {
                button.find('.favorite-icon').show(); // Показываем "heart-fill"
                button.find('.non-favorite-icon').hide(); // Скрываем "heart"
            } else {
                button.find('.favorite-icon').hide(); // Скрываем "heart-fill"
                button.find('.non-favorite-icon').show(); // Показываем "heart"
            }
        },
        error: function(xhr, status, error) {
            alert(xhr.responseJSON.error || 'Ошибка при обработке запроса');
        }
    });
});
</script>
<script>
    $(document).ready(function() {
        // Фильтрация по марке
        $('#brand-filter').change(function() {
            var brandId = $(this).val();
            $('#model-filter').prop('disabled', !brandId);

            $.ajax({
                url: '{% url "get_models_by_brand" %}',
                data: { 'brand_id': brandId },
                success: function(data) {
                    $('#model-filter').empty();
                    $('#model-filter').append('<option value="">Выберите модель</option>');
                    $.each(data.models, function(index, model) {
                        $('#model-filter').append('<option value="' + model.id + '">' + model.name + '</option>');
                    });
                }
            });

            // Обновление списка автомобилей при выборе марки
            updateCarList(brandId, $('#model-filter').val(), $('#drive-type-filter').val(), $('#transmission-filter').val(), $('#horsepower-min').val(), $('#horsepower-max').val());
        });

        // Фильтрация по модели
        $('#model-filter').change(function() {
            updateCarList($('#brand-filter').val(), $(this).val(), $('#drive-type-filter').val(), $('#transmission-filter').val(), $('#horsepower-min').val(), $('#horsepower-max').val());
        });

        // Фильтрация по типу привода
        $('#drive-type-filter').change(function() {
            updateCarList($('#brand-filter').val(), $('#model-filter').val(), $(this).val(), $('#transmission-filter').val(), $('#horsepower-min').val(), $('#horsepower-max').val());
        });

        // Фильтрация по коробке передач
        $('#transmission-filter').change(function() {
            updateCarList($('#brand-filter').val(), $('#model-filter').val(), $('#drive-type-filter').val(), $(this).val(), $('#horsepower-min').val(), $('#horsepower-max').val());
        });

        // Фильтрация по мощности
        $('#horsepower-min, #horsepower-max').change(function() {
            updateCarList($('#brand-filter').val(), $('#model-filter').val(), $('#drive-type-filter').val(), $('#transmission-filter').val(), $('#horsepower-min').val(), $('#horsepower-max').val());
        });

        // Сброс фильтров
        $('#reset-filters').click(function() {
            $('#brand-filter').val('');
            $('#model-filter').empty().append('<option value="">Выберите модель</option>').prop('disabled', true);
            $('#drive-type-filter').val('');
            $('#transmission-filter').val('');
            $('#horsepower-min').val('');
            $('#horsepower-max').val('');
            updateCarList('', '', '', '', '', '');
        });

     // Обработчик применения фильтров
        $('#apply-filters').click(function() {
            updateCarList(
                $('#brand-filter').val(),
                $('#model-filter').val(),
                $('#drive-type-filter').val(),
                $('#transmission-filter').val(),
                $('#horsepower-min').val(),
                $('#horsepower-max').val()
            );
        });

        // Функция для обновления списка автомобилей
        function updateCarList(brandId, modelId, driveType, transmission, horsepowerMin, horsepowerMax) {
            $.ajax({
                url: '{% url "filter_cars" %}',
                data: {
                    'brand_id': brandId,
                    'model_id': modelId,
                    'drive_type': driveType,
                    'transmission': transmission,
                    'horsepower_min': horsepowerMin,
                    'horsepower_max': horsepowerMax
                },
                success: function(data) {
                    $('#car-list').html(data);
                }
            });
        }
    });
</script>
{% endblock %}